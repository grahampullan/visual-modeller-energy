<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> 
</head>

<body>

    <input type="range" id="solar-slider" min="0" max="2" value="1" step="any">


    <div id = "plot-target"></div>

    <script type="module">

        import { Model, Link, Log, Socket, LoadNode, GridSupplyNode, GridExportNode, SolarPVNode, ControllerNode } from '../../build/visual-modeller-energy.js';
        import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm";
        import * as d3 from "https://cdn.skypack.dev/d3@7";

        const npts = 24*60; // minutes in a day
        //const npts = 5;
        const time = d3.range(npts);
        const load = time.map(d => (500 + 500*Math.exp( -1.*((d-300)/80)**2 ) + 1000*Math.exp( -1.*((d-1000)/120)**2 ) ));
        const solar = time.map(d => 2000*Math.exp( -1.*((d-720)/160)**2 ));


        const model = new Model({timeSteps: npts, timeVarying:true });
        const gridSupplyNode = new GridSupplyNode({});
        const loadNode = new LoadNode({socketState:{max: null, value:null, valueType:"constraint", timeVarying: true, timeSeries: load}});
        const solarNode = new SolarPVNode({socketState:{max: null, value:null, valueType:"constraint", timeVarying: true, timeSeries: solar}});
        const gridExportNode = new GridExportNode({});
        model.addNode(gridSupplyNode);
        model.addNode(loadNode);
        model.addNode(solarNode);
        model.addNode(gridExportNode);
        const controllerSolarSocket = new Socket({name:"Solar PV cont", position:"left" });
        const controllerGridSupplySocket = new Socket({name:"Grid Supply cont", position:"left"});
        const controllerLoadSocket = new Socket({name:"Load cont", position:"right"});
        const controllerGridExportSocket = new Socket({name:"Grid Export cont", position:"right"});
        const controllerSockets = [controllerSolarSocket, controllerGridSupplySocket, controllerLoadSocket, controllerGridExportSocket];
        const controllerNode = new ControllerNode({sockets: controllerSockets, inputSocketOrder:["Solar PV cont", "Grid Supply cont"], outputSocketOrder:[ "Load cont", "Grid Export cont"]});
        model.addNode(controllerNode);


        const link1 = new Link({socket1: solarNode.sockets[0], socket2: controllerSolarSocket});
        const link2 = new Link({socket1: gridSupplyNode.sockets[0], socket2: controllerGridSupplySocket});
        const link3 = new Link({socket1: controllerLoadSocket, socket2: loadNode.sockets[0]});
        const link4 = new Link({socket1: controllerGridExportSocket, socket2: gridExportNode.sockets[0]});
        model.addLink(link1);
        model.addLink(link2);
        model.addLink(link3);
        model.addLink(link4);
        console.log(model);
        model.addLog(new Log({name:"solar supply", target:solarNode.sockets[0]}));
        model.addLog(new Log({name:"grid supply", target:link2}));
        model.addLog(new Log({name:"load", target:loadNode.sockets[0]}));
        model.addLog(new Log({name:"grid export", target:link4}));

        model.run();
        plotLogs();


        function plotLogs() {
            const plotData = time.map((t,i) => {
                const obj = {time: t};
                model.logs.forEach(l => {
                    obj[l.name] = l.states[i].value;
                });
                return obj;
            });

            const plot = Plot.plot({
                marks: [
                    Plot.line(plotData, {x: "time", y: "solar supply", stroke: "yellow"}),
                    Plot.line(plotData, {x: "time", y: "grid supply", stroke: "green"}),
                    Plot.line(plotData, {x: "time", y: "load", stroke: "black"}),
                    Plot.line(plotData, {x: "time", y: "grid export", stroke: "red"}),
                    Plot.ruleY([0]),
                    Plot.ruleY([4000]),
                    Plot.ruleX([0])
                ],
                x: {label: "Time (min)"},
                y: {label: "Power (W)"}
            });

            // use d3 to remove the old plot and add the new one
            d3.select("#plot-target").selectAll("*").remove();
            d3.select("#plot-target").node().append(plot);
        }

        d3.select("#solar-slider").on("input", function() {
            updateSolar(+this.value);
        });

        function updateSolar(value) {
            solarNode.sockets[0].state.timeSeries = solar.map(s => s*value);
            model.clearLogs();
            model.run();
            plotLogs();
        }



    </script>
</body>


</html>